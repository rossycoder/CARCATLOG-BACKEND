function extractNumber(value){if(value===null||value===undefined||value==="")return null;if(typeof value==="number")return value;if(typeof value==="string"){const cleaned=value.replace(/[^0-9.-]/g,"");const parsed=parseFloat(cleaned);return isNaN(parsed)?null:parsed}return null}function normalizeFuelType(fuelType){if(!fuelType||typeof fuelType!=="string")return"Unknown";const normalized=fuelType.toLowerCase().trim();if(normalized.includes("petrol")||normalized.includes("gasoline"))return"Petrol";if(normalized.includes("diesel"))return"Diesel";if(normalized.includes("electric")||normalized.includes("ev"))return"Electric";if(normalized.includes("hybrid"))return"Hybrid";if(normalized.includes("plug-in"))return"Plug-in Hybrid";return fuelType.charAt(0).toUpperCase()+fuelType.slice(1).toLowerCase()}function normalizeTransmission(transmission){if(!transmission||typeof transmission!=="string")return"Unknown";const normalized=transmission.toLowerCase().trim();if(normalized.includes("manual"))return"Manual";if(normalized.includes("automatic")||normalized.includes("auto"))return"Automatic";if(normalized.includes("semi")||normalized.includes("cvt")||normalized.includes("dsg"))return"Semi-Automatic";return transmission.charAt(0).toUpperCase()+transmission.slice(1).toLowerCase()}function parseCheckCarDetailsResponse(data){if(!data)return{};const vehicleId=data.VehicleIdentification||{};const bodyDetails=data.BodyDetails||{};const performance=data.Performance||{};const consumption=data.Consumption||{};const modelData=data.ModelData||{};const transmission=data.Transmission||{};return{make:vehicleId.DvlaMake||vehicleId.Make||null,model:vehicleId.DvlaModel||vehicleId.Model||null,variant:modelData.Range||modelData.Variant||null,year:extractNumber(vehicleId.YearOfManufacture),fuelType:normalizeFuelType(vehicleId.FuelType),transmission:normalizeTransmission(transmission.TransmissionType||transmission.Type),bodyType:bodyDetails.BodyShape||bodyDetails.BodyType||null,doors:extractNumber(bodyDetails.NumberOfDoors),seats:extractNumber(bodyDetails.NumberOfSeats),engineSize:extractNumber(vehicleId.EngineCapacity),urbanMpg:extractNumber(consumption.UrbanMpg),extraUrbanMpg:extractNumber(consumption.ExtraUrbanMpg),combinedMpg:extractNumber(consumption.CombinedMpg),co2Emissions:extractNumber(consumption.Co2Emissions),insuranceGroup:extractNumber(modelData.InsuranceGroup),annualTax:extractNumber(modelData.AnnualTax||modelData.VehicleTax),power:extractNumber(performance.Power),torque:extractNumber(performance.Torque),acceleration:extractNumber(performance.Acceleration),topSpeed:extractNumber(performance.TopSpeed)}}function parseValuationResponse(data){if(!data||!data.ValuationList)return null;const valuation=data.ValuationList;return{dealerPrice:extractNumber(valuation.DealerForecourt),privatePrice:extractNumber(valuation.PrivateClean),partExchangePrice:extractNumber(valuation.PartExchange),tradePrice:extractNumber(valuation.TradeAverage),estimatedValue:extractNumber(valuation.PrivateClean)}}function parseVehicleRegistrationResponse(data){if(!data)return{};return{vrm:data.registrationNumber||data.vrm||null,make:data.Make||data.make||null,model:data.Model||data.model||null,colour:data.Colour||data.colour||null,year:extractNumber(data.YearOfManufacture||data.year),fuelType:normalizeFuelType(data.FuelType||data.fuelType)}}function parseVehicleSpecsResponse(data){if(!data)return{};const vehicleId=data.VehicleIdentification||{};const bodyDetails=data.BodyDetails||{};return{make:vehicleId.DvlaMake||vehicleId.Make||null,model:vehicleId.DvlaModel||vehicleId.Model||null,doors:extractNumber(bodyDetails.NumberOfDoors),seats:extractNumber(bodyDetails.NumberOfSeats),bodyType:bodyDetails.BodyShape||bodyDetails.BodyType||null,engineSize:extractNumber(vehicleId.EngineCapacity)}}function parseMileageResponse(data){if(!data)return{vrm:null,readings:[]};const readings=(data.mileage||[]).map(reading=>({mileage:extractNumber(reading.Mileage),date:reading.Date,source:reading.Source}));return{vrm:data.registrationNumber||data.vrm||null,readings:readings}}function parseMOTResponse(data){if(!data)return{vrm:null,tests:[]};const tests=(data.motHistory||data.motTests||[]).map(test=>({completedDate:test.completedDate,testResult:test.testResult,odometerValue:extractNumber(test.odometerValue),expiryDate:test.expiryDate}));return{vrm:data.registrationNumber||data.vrm||null,tests:tests,motStatus:data.motStatus||null,motDueDate:data.motDueDate||null}}module.exports={extractNumber,normalizeFuelType,normalizeTransmission,parseCheckCarDetailsResponse,parseValuationResponse,parseVehicleRegistrationResponse,parseVehicleSpecsResponse,parseMileageResponse,parseMOTResponse}
